<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Mapa Lavaderos</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        
        #map {
            height: 100vh;
        }
        
        .splide {
            position: fixed;
            bottom: 6.5rem;
            left: 0px;
        }
        
        .splide.bd-filter {
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }
        
        .splide__slide__container {
            background-color: #ffffff91;
            border: solid 0.3em lightgrey;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            width: 50vw;
        }
        /* .info{
        height:60%;
      } */
        
        .titulo {
            margin: 4% 2% 5% 2%;
            text-align: center;
            color: #091782;
            font-size: 1.4em;
        }
        
        .precio {
            text-align: center;
            margin: 0px 3%;
            font-style: italic;
            color: #383838;
            font-weight: 300;
            font-size: 0.9em;
        }
        
        .boton-compra {
            border: none;
            background-color: coral;
            font-size: 1em;
            height: 4vh;
            color: white;
            margin-bottom: 3%;
        }
        
        .btnn {
            width: 2em;
            height: 2em;
            border-radius: 0px;
            background-color: #707070;
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            border: 0;
            padding: 0px;
            color: white;
        }
        
        .btnn:active {
            background-color: #a0a0a0;
        }
        
        .cred_text {
            font-size: 1.5em;
            font-weight: bold;
            font-family: Roboto;
            margin: 0.3em 0.5em;
            display: inline-block;
            min-width: 2em;
        }
        
        .swal2-html-container {
            padding-top: 5%;
        }
        
        .swal2-loader {
            border-color: rgb(235, 116, 0) transparent rgb(235, 116, 0) transparent !important;
        }
        
        .swal2-actions {
            margin: 0.25em auto 0 !important;
            padding: 0 0.6em !important;
        }
        /* Optional: Makes the sample page fill the window. */
        
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Roboto;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@2.4.21/dist/css/themes/splide-default.min.css">
</head>

<body>
    <div id="map"></div>
    <button id="button"></button>
    <div class="splide">
        <div class="splide__track">
            <ul id="slider" class="splide__list">
            </ul>
        </div>
    </div>
</body>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA88F-102I-6vf11EDKFMvn_WKOjc2eIG4"></script>
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@2.4.21/dist/js/splide.min.js"></script>
<link rel="stylesheet" href="res\dark.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    var queryDict = {}
    location.search.substr(1).split("&").forEach(function(item) {
        queryDict[item.split("=")[0]] = item.split("=")[1]
    })
    var zoom_actual = parseInt(queryDict.zoom);
    var id_lav = queryDict.id_lav;
    var platform = queryDict.platform;
    var map;
    var indexLavaderoCercano = 0;
    var distancias = [];
    var click = false;
    var rcv_pos;
    if (queryDict.lat != undefined && queryDict.long != undefined) {
        rcv_pos = {
            lat: parseFloat(queryDict.lat),
            lng: parseFloat(queryDict.long),
        }
    } else {
        rcv_pos = undefined;
    }
    var lavaderos;
    var cant_cred;
    var boton = []
    var slider = document.getElementById("slider");
    var splide = new Splide('.splide', {
        type: 'loop',
        perPage: 2,
        // height:'7rem',
        focus: 'center',
        trimSpace: false,
        arrows: false,
        pagination: false,
        gap: '2em',
        cover: true,
    });

    fetch('https://www.aquaexpress.com.ar/aqua4d/lista_lavaderos.php')
        .then(res => res.json())
        .then((out) => {
            lavaderos = out.items.filter(l => l.direccion != 'OCULTO');
            for (var i = 0; i < (lavaderos.length); i++) {
                var titulo = document.createElement("h2");
                titulo.setAttribute("class", "titulo");
                titulo.innerHTML = lavaderos[i].nombre;
                var divinfo = document.createElement("div");
                divinfo.setAttribute("class", "info")
                divinfo.appendChild(titulo);
                var container = document.createElement("div")
                container.setAttribute("class", "splide__slide__container");
                container.appendChild(divinfo);
                // if(platform=="android"){
                //   boton[i] = document.createElement("button");
                //   boton[i].setAttribute("class","boton-compra");
                //   boton[i].innerHTML="Como llegar?"
                //   container.appendChild(boton[i]);
                // }
                var item = document.createElement("li");
                item.setAttribute("class", "splide__slide");
                item.appendChild(container);
                slider.appendChild(item);
                // if(platform=="android"){
                // // boton[i].setAttribute("onclick",`window.open('https://www.google.com/maps/dir/?api=1&destination=${lavaderos[i].latitud},${lavaderos[i].longitud}&travelmode=driving','_system')`);
                //   boton[i].setAttribute("onclick",`window.open('geo:0,0?q=${lavaderos[i].latitud},${lavaderos[i].longitud}','_system')`);
                // // boton[i].setAttribute("onclick",`window.open('google.navigation:q=${lavaderos[i].latitud},${lavaderos[i].longitud}&mode=d','_system')`);
                // }
                distancias[i] = Math.abs(modulo((rcv_pos.lat - lavaderos[i].latitud), (rcv_pos.lng - lavaderos[i].longitud)))
            }
            indexLavaderoCercano = distancias.findIndex((item) => item == Math.min.apply(null, distancias));
            splide.mount();
            splide.on('moved', function(newIndex, oldIndex) {
                window["infowindow" + oldIndex].close(map, window["marker" + oldIndex]);
                window["infowindow" + newIndex].open(map, window["marker" + newIndex]);
                if (!click) {
                    let pos = window["infowindow" + newIndex].getPosition().toJSON();
                    map.setCenter(pos);
                } else {
                    click = false;
                }
            })
            initialize()
                .then(() => {
                    if (id_lav != undefined && id_lav != "") {
                        Swal.fire({
                            text: "Localizando lavadero...",
                            allowOutsideClick: false,
                            width: "80%",
                            showConfirmButton: false,
                            onBeforeOpen: () => {
                                Swal.showLoading()
                            }
                        })
                        setTimeout(() => {
                            splide.go(lavaderos.findIndex((item) => {
                                return item.external_id == id_lav
                            }));
                            Swal.close();
                        }, 3500)
                    } else {
                        Swal.fire({
                            text: "Buscando el lavadero mas cercano...",
                            allowOutsideClick: false,
                            width: '80%',
                            showConfirmButton: false,
                            onBeforeOpen: () => {
                                Swal.showLoading()
                            }
                        })
                        setTimeout(() => {
                            document.getElementsByClassName('splide')[0].classList.add(['bd-filter'])
                            splide.go(indexLavaderoCercano);
                            Swal.close();
                        }, 1000)
                    }
                })
                .catch((err) => {
                    console.log(err)
                });

            // setTimeout(()=>{
            //   console.log("Timeout!")
            //   splide.go(indexLavaderoCercano);
            // },10000);
        })
        // .then(()=>{
        //   splide.go(indexLavaderoCercano);
        // })
        .catch((err) => {
            Swal.fire("Ups!", "Ha ocurrido un error. Intenta nuevamente mas tarde." + err, "error")
        })

    function modulo(i, j) {
        return ((i ** 2) + (j ** 2));
    }

    function initialize() {
        return new Promise(function(resolve, reject) {
            //Opciones del mapa inicial
            if (rcv_pos != undefined) {
                var mapOptions = {
                    zoom: zoom_actual,
                    center: {
                        lat: rcv_pos.lat,
                        lng: rcv_pos.lng
                    },
                    disableDefaultUI: true,
                };
            } else {
                var mapOptions = {
                    zoom: zoom_actual,
                    disableDefaultUI: true,
                };
            }

            //Creacion del mapa inicial
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            const upperText = document.createElement("h2");
            upperText.innerHTML = "BUSCA TU LAVADERO MAS CERCANO";
            upperText.style.margin = "0px 5px";
            upperText.style.backdropFilter = "blur(2px)";
            upperText.style.backgroundColor = "#0182bdbf";
            upperText.style.padding = "2%";
            upperText.style.color = "#ffffff";
            upperText.style.width = "-webkit-fill-available";
            upperText.style.textAlign = "center";
            upperText.style.borderRadius = "0px 0px 10px 10px"
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(upperText);
            if (rcv_pos != undefined) {
                infoWindow = new google.maps.InfoWindow();
                infoWindow.setPosition(rcv_pos);
                infoWindow.setContent("Tu ubicaci√≥n");
                var locationButton = document.getElementById("button");
                locationButton.innerHTML = '<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="crosshairs" style="width:2em; height:2em;" class="svg-inline--fa fa-crosshairs fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M500 224h-30.364C455.724 130.325 381.675 56.276 288 42.364V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v30.364C130.325 56.276 56.276 130.325 42.364 224H12c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h30.364C56.276 381.675 130.325 455.724 224 469.636V500c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12v-30.364C381.675 455.724 455.724 381.675 469.636 288H500c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12zM288 404.634V364c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40.634C165.826 392.232 119.783 346.243 107.366 288H148c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-40.634C119.768 165.826 165.757 119.783 224 107.366V148c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12v-40.634C346.174 119.768 392.217 165.757 404.634 224H364c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40.634C392.232 346.174 346.243 392.217 288 404.634zM288 256c0 17.673-14.327 32-32 32s-32-14.327-32-32c0-17.673 14.327-32 32-32s32 14.327 32 32z"></path></svg>';
                locationButton.classList.add("custom-map-control-button");
                locationButton.style.color = "#000000";
                locationButton.style.padding = "0.35em 0.3em 0.2em 0.3em";
                locationButton.style.border = "none";
                locationButton.style.position = "absolute";
                locationButton.style.right = "5px";
                locationButton.style.backgroundColor = "#ffffffb8";
                locationButton.style.backdropFilter = "blur(2px)";
                locationButton.style.borderRadius = "10px";
                locationButton.style.bottom = "6.7rem";
                locationButton.addEventListener("click", () => {
                    infoWindow.open(map);
                    map.setCenter(rcv_pos);
                });
                infoWindow.open(map);
            }

            for (var i = 0; i < lavaderos.length; i += 1) {
                if (lavaderos[i].tipo_lavadero.includes("4D")) {
                    var icon = {
                        url: "https://www.aquaexpress.com.ar/aqua4d/images/mapa/icon_4d.png", // url
                        scaledSize: new google.maps.Size(50, 50), // size
                    };
                } else {
                    var icon = {
                        url: "https://www.aquaexpress.com.ar/aqua4d/images/mapa/icon_lav.png", // url
                        scaledSize: new google.maps.Size(50, 50), // size
                    };
                }
                window["marker" + i] = new google.maps.Marker({
                    position: {
                        lat: parseFloat(lavaderos[i].latitud),
                        lng: parseFloat(lavaderos[i].longitud)
                    },
                    map: map,
                    icon: icon,
                    title: lavaderos[i].nombre
                });

                var contentString = `<h2 style="margin-block-start:0.2em;margin-block-end:0.1em"><span class='glyphicon glyphicon-asterisk' aria-hidden='true'></span>&#160;${lavaderos[i].nombre}</h2><p style="margin-block-start:0.1em;margin-block-end:0.2em"><span class='glyphicon glyphicon-screenshot' aria-hidden='true'></span>&#160;<b>Direccion</b><br>${lavaderos[i].direccion} </p>`

                window["infowindow" + i] = new google.maps.InfoWindow({
                    content: contentString
                });

                eval(
                    "marker" + i + ".addListener('click', () => {splide.go(" + i + ");click=true;});"
                )
            }
            resolve()
        })
    }
</script>

</html>